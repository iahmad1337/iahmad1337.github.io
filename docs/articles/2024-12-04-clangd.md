# Clangd LSP
Prebuilt packages didn't work, so I had to build it from source:

- https://llvm.org/docs/GettingStarted.html
- take source code from a tar.gz here: https://github.com/llvm/llvm-project/releases
- How to build just clangd: https://github.com/llvm/llvm-project/tree/main/clang-tools-extra/clangd#building-and-testing-clangd
- buildiing llvm from source details: https://llvm.org/docs/CMake.html

TL;DR:
```bash
# get the llvm source
wget https://github.com/llvm/llvm-project/archive/refs/tags/llvmorg-12.0.1.tar.gz
tar -xf llvmorg-12.0.1.tar.gz

# use the latest gcc and cmake just in case
source /opt/rh/devtoolset-11/enable
wget https://github.com/Kitware/CMake/releases/download/v3.31.0/cmake-3.31.0-linux-x86_64.tar.gz
tar -xf cmake-3.31.0-linux-x86_64.tar.gz
export PATH=$(pwd)/cmake-3.31.0-linux-x86_64/bin:$PATH

# prepare the build files in llvm-12-build/ directory
mkdir -p llvm-12-build/
cmake \
    -S llvm-project-llvmorg-12.0.1/llvm \
    -B llvm-12-build \
    -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=$HOME/programs/llvm-12-install \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DBUILD_SHARED_LIBS=on\
    -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" \
    -DLLVM_TARGETS_TO_BUILD="host" \
    -DLLVM_PARALLEL_LINK_JOBS=1 \
    -DLLVM_PARALLEL_COMPILE_JOBS=4

# Explanation:
# - -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" is needed for clangd to be
#   built
# - -DLLVM_PARALLEL_LINK_JOBS=1 is used to avoid linker OOM death

# do the build
ninja -C llvm-12-build/ clangd

# do the installation
cd llvm-12-build
cmake --build . --target install

# add binaries to path
cd ../llvm-12-install/bin
for i in clang*; do ln -s $(realpath $i) ~/.local/bin/$i; done
```

The build lasted for 2-3 hours; installation also took quite a bit of time (~1 hour).

You can track the elapsed time with this script:
```bash
start=$(date +%s); while pidof ninja &>/dev/null; do sleep 30;  cur=$(date +%s); echo "seconds elapsed $((cur - start))"; done
```


## Compilation database
To generate, do

```bash
cmake -S $src -B $bld -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
cp $bld/compile_commands.json $src
```

The raw `compile_commands.json` may not work out of the box, as some flags are
redundant/missing. Here's a fix:
```bash
compile-commands -v --file ./compile_commands.json --add_flags='-std=c++17'
sed -i "/no-extended-identifiers/d" ./compile_commands.json
```

The `compile-commands` utility can be installed via `pip3 install compile-commands`
(note that the minimum required python version is 3.8).

And that's it!
